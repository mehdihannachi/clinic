{"filter":false,"title":"chatSingleHistoryController.js","tooltip":"/views/assets/js/controllers/chatSingleHistoryController.js","undoManager":{"mark":84,"position":84,"stack":[[{"start":{"row":0,"column":0},"end":{"row":206,"column":0},"action":"insert","lines":["// chatController contoller ","materialAdmin.controller('chatSingleController', function($location, $sce, $uibModal, $timeout, $scope, $http, $resource, $window, $state, $sessionStorage, $uibModal, $rootScope, growlService, Socket, usSpinnerService) {","","    //to test if we are in the single chat view","    $rootScope.inChat = true;","","","    //socket for receiving new message","    Socket.on('hello', function(data) {","        console.log(data)","    })","","    Socket.on('newMessage', function(data) {","        if ($location.path() == '/single-chat') {","            if (data.to == $sessionStorage.connectedUser.user_id && data.from == $scope.discussion.correspondant.user_id) {","                $scope.$emit('customEvent');","                if (data.from == $scope.discussion.correspondant.user_id) {","                    data.fromUser = $scope.discussion.correspondant;","                    data.messageClass = 'lv-item media';","                    data.user_avatar = 'lv-avatar pull-left'","                }","                else {","                    data.fromUser = $scope.connectedUser;","                    data.messageClass = 'lv-item media right';","                    data.user_avatar = 'lv-avatar pull-right'","                }","                $scope.discussion.messages.push(data);","                $scope.playAudio()","                $timeout(function() {","                    var scroller = document.getElementById(\"div1\");","                    scroller.scrollTop = scroller.scrollHeight;","                }, 0, false);","            }","            else if (data.to == $sessionStorage.connectedUser.user_id) {","                $scope.$emit('customEvent');","            }","        }","    });","","    //function to play sound (used in socket)","    $scope.playAudio = function() {","        var audio = new Audio('audio/notification.mp3');","        audio.play();","    };","","    // function to stop the spinner after data loads","    $scope.stopSpin = function() {","        usSpinnerService.stop('spinner-chat');","    }","","    //init the controller","    $rootScope.initSingleChat = function() {","        $scope.correspondant;","        $scope.connectedUser = $sessionStorage.connectedUser;","        $http.get('/chat/discussion/' + $sessionStorage.discussion.id).success(function(response) {","            $scope.discussion = response.data;","            $http.post('/chat/seenOnMessages', {","                messages: $scope.discussion.messages,","                messagesTo: $sessionStorage.connectedUser","            }).success(function(response) {","                //$scope.$emit('customEvent');","                $scope.discussion.messages.forEach(function(message) {","                    if (message.from == $scope.discussion.correspondant.user_id) {","                        message.fromUser = $scope.discussion.correspondant;","                        message.messageClass = 'lv-item media fades';","                        message.user_avatar = 'lv-avatar pull-left'","                    }","                    else {","                        message.fromUser = $scope.connectedUser;","                        message.messageClass = 'lv-item media right fades';","                        message.user_avatar = 'lv-avatar pull-right'","                    }","                })","","                $scope.chatDiscussion = $scope.discussion;","                $scope.data = $scope.discussion.messages.slice(0, 5);","","","                $scope.stopSpin()","                $timeout(function() {","                    var scroller = document.getElementById(\"div1\");","                    scroller.scrollTop = scroller.scrollHeight;","                }, 0, false);","","            }).error(function(response) {","                $scope.error = response.message;","            });","        }).error(function(response) {","            $scope.error = response.message;","        });","","    }","","    $rootScope.initSingleChat();","","","    //redirection to new chat","    $scope.newChat = function(user_id) {","        $http.post('/chat/new/', {","            connectedUser: $sessionStorage.connectedUser,","            correspondant_id: user_id","        }).success(function(response) {","            $state.go('newChat')","","        }).error(function(response) {","            $scope.error = response.message;","        });","    }","","","    $scope.enterPress = function(keyEvent) {","            if (keyEvent.which === 13)","                $scope.sendMessage();","        }","        //send message ","    $scope.sendMessage = function() {","        if ($scope.messageText != '') {","            var correspondantId;","            var discussion = $sessionStorage.discussion;","            discussion.users.forEach(function(user) {","                if (user._id != $sessionStorage.connectedUser.user_id)","                    correspondantId = user._id;","            })","            $http.post('/chat/sendMessage/', {","                discussionId: discussion.id,","                correspondant_id: correspondantId,","                message: $scope.messageText","            }).success(function(response) {","                console.log(response)","                $scope.glued = true;","                Socket.emit('newMessage', response.message);","                $scope.checkSeen()","                if (response.message.from == $scope.discussion.correspondant.user_id) {","                    response.message.fromUser = $scope.discussion.correspondant;","                    response.message.messageClass = 'lv-item media fades';","                    response.message.user_avatar = 'lv-avatar pull-left'","                }","                else {","                    response.message.fromUser = $scope.connectedUser;","                    response.message.messageClass = 'lv-item media right fades';","                    response.message.user_avatar = 'lv-avatar pull-right'","                }","                $scope.discussion.messages.push(response.message);","                $timeout(function() {","                    var scroller = document.getElementById(\"div1\");","                    scroller.scrollTop = scroller.scrollHeight;","                }, 0, false);","                $scope.messageText = '';","                $scope.$emit('customEvent');","            }).error(function(response) {","                $scope.error = response.message;","            });","        }","    }","","    //seen on messages that are sent to me, called after every sendMessage","    $scope.checkSeen = function() {","        $http.post('/chat/seenOnMessages', {","            messages: $scope.discussion.messages,","            messagesTo: $sessionStorage.connectedUser","        }).success(function(response) {}).error(function(response) {","            $scope.error = response.message;","        });","","    }","","    //delete the conversation im in","    $scope.deleteModal = function(id) {","        var uibModalInstance = $uibModal.open({","            animation: true,","            ariaLabelledBy: 'modal-title',","            ariaDescribedBy: 'modal-body',","            animation: true,","            templateUrl: 'myModalContent.html',","            backdrop: 'static',","            controller: function($uibModalInstance, $scope, $rootScope) {","                $scope.ok = function() {","                    $http.post(\"chat/delete/\" + id)","                        .success(function() {","                            // $state.reload();","                            uibModalInstance.dismiss();","                            $sessionStorage.discussion = null;","                            $state.go('messages')","                            growlService.growl('Conversation deleted ', 'inverse');","                        })","                        .error(function() {","","                        });","                };","                $scope.cancel = function() {};","","            },","            size: 'sm'","        });","    }","","    $(\"textarea\").keydown(function(e) {","        // Enter was pressed without shift key","        if (e.keyCode == 13 && !e.shiftKey) {","            e.preventDefault();","            $scope.sendMessage();","        }","    });","","","})",""],"id":1}],[{"start":{"row":1,"column":36},"end":{"row":1,"column":37},"action":"insert","lines":["H"],"id":2}],[{"start":{"row":1,"column":37},"end":{"row":1,"column":38},"action":"insert","lines":["i"],"id":3}],[{"start":{"row":1,"column":38},"end":{"row":1,"column":39},"action":"insert","lines":["s"],"id":4}],[{"start":{"row":1,"column":39},"end":{"row":1,"column":40},"action":"insert","lines":["t"],"id":5}],[{"start":{"row":1,"column":40},"end":{"row":1,"column":41},"action":"insert","lines":["o"],"id":6}],[{"start":{"row":1,"column":41},"end":{"row":1,"column":42},"action":"insert","lines":["r"],"id":7}],[{"start":{"row":1,"column":42},"end":{"row":1,"column":43},"action":"insert","lines":["y"],"id":8}],[{"start":{"row":14,"column":43},"end":{"row":14,"column":56},"action":"remove","lines":["connectedUser"],"id":14},{"start":{"row":14,"column":43},"end":{"row":14,"column":54},"action":"insert","lines":["userProfile"]},{"start":{"row":22,"column":43},"end":{"row":22,"column":56},"action":"remove","lines":["connectedUser"]},{"start":{"row":22,"column":43},"end":{"row":22,"column":54},"action":"insert","lines":["userProfile"]},{"start":{"row":33,"column":48},"end":{"row":33,"column":61},"action":"remove","lines":["connectedUser"]},{"start":{"row":33,"column":48},"end":{"row":33,"column":59},"action":"insert","lines":["userProfile"]},{"start":{"row":53,"column":15},"end":{"row":53,"column":28},"action":"remove","lines":["connectedUser"]},{"start":{"row":53,"column":15},"end":{"row":53,"column":26},"action":"insert","lines":["userProfile"]},{"start":{"row":53,"column":45},"end":{"row":53,"column":58},"action":"remove","lines":["connectedUser"]},{"start":{"row":53,"column":45},"end":{"row":53,"column":56},"action":"insert","lines":["userProfile"]},{"start":{"row":58,"column":44},"end":{"row":58,"column":57},"action":"remove","lines":["connectedUser"]},{"start":{"row":58,"column":44},"end":{"row":58,"column":55},"action":"insert","lines":["userProfile"]},{"start":{"row":68,"column":50},"end":{"row":68,"column":63},"action":"remove","lines":["connectedUser"]},{"start":{"row":68,"column":50},"end":{"row":68,"column":61},"action":"insert","lines":["userProfile"]},{"start":{"row":99,"column":12},"end":{"row":99,"column":25},"action":"remove","lines":["connectedUser"]},{"start":{"row":99,"column":12},"end":{"row":99,"column":23},"action":"insert","lines":["userProfile"]},{"start":{"row":99,"column":41},"end":{"row":99,"column":54},"action":"remove","lines":["connectedUser"]},{"start":{"row":99,"column":41},"end":{"row":99,"column":52},"action":"insert","lines":["userProfile"]},{"start":{"row":120,"column":48},"end":{"row":120,"column":61},"action":"remove","lines":["connectedUser"]},{"start":{"row":120,"column":48},"end":{"row":120,"column":59},"action":"insert","lines":["userProfile"]},{"start":{"row":138,"column":55},"end":{"row":138,"column":68},"action":"remove","lines":["connectedUser"]},{"start":{"row":138,"column":55},"end":{"row":138,"column":66},"action":"insert","lines":["userProfile"]},{"start":{"row":159,"column":40},"end":{"row":159,"column":53},"action":"remove","lines":["connectedUser"]},{"start":{"row":159,"column":40},"end":{"row":159,"column":51},"action":"insert","lines":["userProfile"]}],[{"start":{"row":34,"column":0},"end":{"row":34,"column":1},"action":"insert","lines":["&"],"id":15}],[{"start":{"row":54,"column":69},"end":{"row":54,"column":70},"action":"insert","lines":[","],"id":16}],[{"start":{"row":54,"column":70},"end":{"row":54,"column":72},"action":"insert","lines":["[]"],"id":17}],[{"start":{"row":54,"column":70},"end":{"row":54,"column":72},"action":"remove","lines":["[]"],"id":18}],[{"start":{"row":54,"column":70},"end":{"row":54,"column":72},"action":"insert","lines":["{}"],"id":19}],[{"start":{"row":54,"column":71},"end":{"row":56,"column":8},"action":"insert","lines":["","            ","        "],"id":20}],[{"start":{"row":55,"column":12},"end":{"row":55,"column":30},"action":"insert","lines":["req.params.user_id"],"id":29}],[{"start":{"row":55,"column":22},"end":{"row":55,"column":23},"action":"remove","lines":["."],"id":30}],[{"start":{"row":55,"column":21},"end":{"row":55,"column":22},"action":"remove","lines":["s"],"id":31}],[{"start":{"row":55,"column":20},"end":{"row":55,"column":21},"action":"remove","lines":["m"],"id":32}],[{"start":{"row":55,"column":19},"end":{"row":55,"column":20},"action":"remove","lines":["a"],"id":33}],[{"start":{"row":55,"column":18},"end":{"row":55,"column":19},"action":"remove","lines":["r"],"id":34}],[{"start":{"row":55,"column":17},"end":{"row":55,"column":18},"action":"remove","lines":["a"],"id":35}],[{"start":{"row":55,"column":16},"end":{"row":55,"column":17},"action":"remove","lines":["p"],"id":36}],[{"start":{"row":55,"column":15},"end":{"row":55,"column":16},"action":"remove","lines":["."],"id":37}],[{"start":{"row":55,"column":14},"end":{"row":55,"column":15},"action":"remove","lines":["q"],"id":38}],[{"start":{"row":55,"column":13},"end":{"row":55,"column":14},"action":"remove","lines":["e"],"id":39}],[{"start":{"row":55,"column":12},"end":{"row":55,"column":13},"action":"remove","lines":["r"],"id":40}],[{"start":{"row":55,"column":19},"end":{"row":55,"column":20},"action":"insert","lines":[":"],"id":41}],[{"start":{"row":55,"column":20},"end":{"row":55,"column":21},"action":"insert","lines":[" "],"id":42}],[{"start":{"row":34,"column":1},"end":{"row":34,"column":2},"action":"remove","lines":[" "],"id":43}],[{"start":{"row":34,"column":0},"end":{"row":34,"column":1},"action":"remove","lines":["&"],"id":44}],[{"start":{"row":55,"column":21},"end":{"row":55,"column":22},"action":"insert","lines":["$"],"id":45}],[{"start":{"row":55,"column":22},"end":{"row":55,"column":23},"action":"insert","lines":["s"],"id":46}],[{"start":{"row":55,"column":23},"end":{"row":55,"column":24},"action":"insert","lines":["e"],"id":47}],[{"start":{"row":55,"column":24},"end":{"row":55,"column":25},"action":"insert","lines":["s"],"id":48}],[{"start":{"row":55,"column":25},"end":{"row":55,"column":26},"action":"insert","lines":["s"],"id":49}],[{"start":{"row":55,"column":21},"end":{"row":55,"column":26},"action":"remove","lines":["$sess"],"id":50},{"start":{"row":55,"column":21},"end":{"row":55,"column":36},"action":"insert","lines":["$sessionStorage"]}],[{"start":{"row":55,"column":36},"end":{"row":55,"column":37},"action":"insert","lines":["."],"id":51}],[{"start":{"row":55,"column":37},"end":{"row":55,"column":38},"action":"insert","lines":["u"],"id":52}],[{"start":{"row":55,"column":38},"end":{"row":55,"column":39},"action":"insert","lines":["s"],"id":53}],[{"start":{"row":55,"column":39},"end":{"row":55,"column":40},"action":"insert","lines":["e"],"id":54}],[{"start":{"row":55,"column":37},"end":{"row":55,"column":40},"action":"remove","lines":["use"],"id":55},{"start":{"row":55,"column":37},"end":{"row":55,"column":48},"action":"insert","lines":["userProfile"]}],[{"start":{"row":55,"column":48},"end":{"row":55,"column":49},"action":"insert","lines":["."],"id":56}],[{"start":{"row":55,"column":49},"end":{"row":55,"column":50},"action":"insert","lines":["i"],"id":57}],[{"start":{"row":55,"column":50},"end":{"row":55,"column":51},"action":"insert","lines":["d"],"id":58}],[{"start":{"row":55,"column":49},"end":{"row":55,"column":51},"action":"remove","lines":["id"],"id":59},{"start":{"row":55,"column":49},"end":{"row":55,"column":56},"action":"insert","lines":["user_id"]}],[{"start":{"row":55,"column":56},"end":{"row":55,"column":57},"action":"insert","lines":["}"],"id":60}],[{"start":{"row":56,"column":8},"end":{"row":56,"column":9},"action":"remove","lines":["}"],"id":61}],[{"start":{"row":55,"column":56},"end":{"row":56,"column":8},"action":"insert","lines":["","        "],"id":62}],[{"start":{"row":54,"column":35},"end":{"row":54,"column":36},"action":"insert","lines":["H"],"id":63}],[{"start":{"row":54,"column":36},"end":{"row":54,"column":37},"action":"insert","lines":["i"],"id":64}],[{"start":{"row":54,"column":37},"end":{"row":54,"column":38},"action":"insert","lines":["s"],"id":65}],[{"start":{"row":54,"column":38},"end":{"row":54,"column":39},"action":"insert","lines":["t"],"id":66}],[{"start":{"row":54,"column":39},"end":{"row":54,"column":40},"action":"insert","lines":["o"],"id":67}],[{"start":{"row":54,"column":40},"end":{"row":54,"column":41},"action":"insert","lines":["r"],"id":68}],[{"start":{"row":54,"column":41},"end":{"row":54,"column":42},"action":"insert","lines":["y"],"id":69}],[{"start":{"row":51,"column":29},"end":{"row":51,"column":30},"action":"insert","lines":["H"],"id":71}],[{"start":{"row":51,"column":30},"end":{"row":51,"column":31},"action":"insert","lines":["i"],"id":72}],[{"start":{"row":51,"column":31},"end":{"row":51,"column":32},"action":"insert","lines":["s"],"id":73}],[{"start":{"row":51,"column":32},"end":{"row":51,"column":33},"action":"insert","lines":["t"],"id":74}],[{"start":{"row":51,"column":33},"end":{"row":51,"column":34},"action":"insert","lines":["o"],"id":75}],[{"start":{"row":51,"column":34},"end":{"row":51,"column":35},"action":"insert","lines":["r"],"id":76}],[{"start":{"row":51,"column":35},"end":{"row":51,"column":36},"action":"insert","lines":["y"],"id":77}],[{"start":{"row":96,"column":15},"end":{"row":96,"column":29},"action":"remove","lines":["initSingleChat"],"id":94},{"start":{"row":96,"column":15},"end":{"row":96,"column":29},"action":"insert","lines":["INITSINGLECHAT"]}],[{"start":{"row":96,"column":29},"end":{"row":96,"column":43},"action":"remove","lines":["initSingleChat"],"id":108},{"start":{"row":96,"column":29},"end":{"row":96,"column":50},"action":"insert","lines":["initSingleChatHistory"]}],[{"start":{"row":71,"column":61},"end":{"row":71,"column":62},"action":"insert","lines":["."],"id":107}],[{"start":{"row":71,"column":61},"end":{"row":71,"column":62},"action":"remove","lines":["."],"id":106}],[{"start":{"row":71,"column":61},"end":{"row":71,"column":62},"action":"insert","lines":["."],"id":105}],[{"start":{"row":71,"column":62},"end":{"row":71,"column":69},"action":"insert","lines":["user_id"],"id":104}],[{"start":{"row":96,"column":28},"end":{"row":96,"column":29},"action":"remove","lines":["T"],"id":109}],[{"start":{"row":96,"column":27},"end":{"row":96,"column":28},"action":"remove","lines":["A"],"id":110}],[{"start":{"row":96,"column":26},"end":{"row":96,"column":27},"action":"remove","lines":["H"],"id":111}],[{"start":{"row":96,"column":25},"end":{"row":96,"column":26},"action":"remove","lines":["C"],"id":112}],[{"start":{"row":96,"column":24},"end":{"row":96,"column":25},"action":"remove","lines":["E"],"id":113}],[{"start":{"row":96,"column":23},"end":{"row":96,"column":24},"action":"remove","lines":["L"],"id":114}],[{"start":{"row":96,"column":22},"end":{"row":96,"column":23},"action":"remove","lines":["G"],"id":115}],[{"start":{"row":96,"column":21},"end":{"row":96,"column":22},"action":"remove","lines":["N"],"id":116}],[{"start":{"row":96,"column":20},"end":{"row":96,"column":21},"action":"remove","lines":["I"],"id":117}],[{"start":{"row":96,"column":19},"end":{"row":96,"column":20},"action":"remove","lines":["S"],"id":118}],[{"start":{"row":96,"column":18},"end":{"row":96,"column":19},"action":"remove","lines":["T"],"id":119}],[{"start":{"row":96,"column":17},"end":{"row":96,"column":18},"action":"remove","lines":["I"],"id":120}],[{"start":{"row":96,"column":16},"end":{"row":96,"column":17},"action":"remove","lines":["N"],"id":121}],[{"start":{"row":96,"column":15},"end":{"row":96,"column":16},"action":"remove","lines":["I"],"id":122}],[{"start":{"row":96,"column":36},"end":{"row":96,"column":38},"action":"insert","lines":["()"],"id":123}],[{"start":{"row":71,"column":61},"end":{"row":71,"column":69},"action":"remove","lines":[".user_id"],"id":124}]]},"ace":{"folds":[],"scrolltop":683,"scrollleft":0,"selection":{"start":{"row":71,"column":61},"end":{"row":71,"column":61},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":44,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1499997939988,"hash":"e3bab7b14a930982f84f946c4d50cdb5a5425e96"}